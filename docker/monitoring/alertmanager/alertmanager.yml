# Alertmanager Configuration
# Defines how alerts are routed and notifications are sent

global:
  # The smarthost and SMTP sender used for mail notifications.
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@localhost'
  smtp_auth_username: 'alertmanager@localhost'
  smtp_auth_password: 'password'

# The directory from which notification templates are read.
templates:
- '/etc/alertmanager/templates/*.tmpl'

# The root route on which each incoming alert enters.
route:
  # The labels by which incoming alerts are grouped together.
  group_by: ['alertname']
  
  # When a new group of alerts is created by an incoming alert, wait at
  # least 'group_wait' to send the initial notification.
  group_wait: 10s
  
  # When the first notification was sent, wait 'group_interval' to send a batch
  # of new alerts that started firing for that group.
  group_interval: 10s
  
  # If an alert has successfully been sent, wait 'repeat_interval' to
  # resend them.
  repeat_interval: 1h
  
  # A default receiver
  receiver: web.hook
  
  # All the above attributes are inherited by all child routes and can
  # overwritten on each.
  routes:
  - match:
      severity: critical
    receiver: critical-alerts
    group_wait: 5s
    repeat_interval: 30m
    
  - match:
      severity: warning
    receiver: warning-alerts
    group_wait: 30s
    repeat_interval: 2h
    
  - match:
      alertname: InstanceDown
    receiver: infrastructure-alerts
    group_wait: 5s
    repeat_interval: 15m
    
  - match:
      alertname: ContainerDown
    receiver: container-alerts
    group_wait: 5s
    repeat_interval: 15m
    
  - match_re:
      alertname: ^(PrometheusDown|GrafanaDown|ElasticsearchDown)$
    receiver: monitoring-alerts
    group_wait: 5s
    repeat_interval: 10m
    
  - match_re:
      alertname: ^(SecurityViolation|SuspiciousLoginAttempts|SSLCertificateExpired)$
    receiver: security-alerts
    group_wait: 0s
    repeat_interval: 30m

# Inhibition rules allow to mute a set of alerts given that another alert is
# firing.
inhibit_rules:
- source_match:
    severity: 'critical'
  target_match:
    severity: 'warning'
  # Apply inhibition if the alertname is the same.
  equal: ['alertname', 'cluster', 'service']

receivers:
- name: 'web.hook'
  webhook_configs:
  - url: 'http://localhost:5001/'
    send_resolved: true

- name: 'critical-alerts'
  email_configs:
  - to: 'admin@localhost'
    subject: '[CRITICAL] Alert: {{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      
      Labels:
      {{ range .Labels.SortedPairs }}
      - {{ .Name }}: {{ .Value }}
      {{ end }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      {{ end }}
    html: |
      <!DOCTYPE html>
      <html>
      <head>
      <style>
      body { font-family: Arial, sans-serif; }
      .critical { color: #d9534f; }
      .warning { color: #f0ad4e; }
      .info { color: #5bc0de; }
      .alert { border-left: 4px solid #d9534f; padding: 10px; margin: 10px 0; }
      </style>
      </head>
      <body>
      <h2 class="critical">Critical Alert Notification</h2>
      {{ range .Alerts }}
      <div class="alert">
      <h3>{{ .Annotations.summary }}</h3>
      <p><strong>Description:</strong> {{ .Annotations.description }}</p>
      <p><strong>Started:</strong> {{ .StartsAt }}</p>
      {{ if .EndsAt }}<p><strong>Ended:</strong> {{ .EndsAt }}</p>{{ end }}
      </div>
      {{ end }}
      </body>
      </html>
      
  webhook_configs:
  - url: 'http://localhost:5001/critical'
    send_resolved: true

- name: 'warning-alerts'
  email_configs:
  - to: 'alerts@localhost'
    subject: '[WARNING] Alert: {{ .GroupLabels.alertname }}'
    body: |
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      
      Labels:
      {{ range .Labels.SortedPairs }}
      - {{ .Name }}: {{ .Value }}
      {{ end }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      {{ end }}

- name: 'infrastructure-alerts'
  email_configs:
  - to: 'infrastructure@localhost'
    subject: '[INFRASTRUCTURE] Alert: {{ .GroupLabels.alertname }}'
    body: |
      Infrastructure Alert Detected
      
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      Instance: {{ .Labels.instance }}
      Job: {{ .Labels.job }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      {{ end }}
      
  slack_configs:
  - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    channel: '#infrastructure'
    title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
    text: |
      {{ range .Alerts }}
      *Alert:* {{ .Annotations.summary }}
      *Description:* {{ .Annotations.description }}
      *Instance:* {{ .Labels.instance }}
      *Started:* {{ .StartsAt }}
      {{ end }}

- name: 'container-alerts'
  email_configs:
  - to: 'containers@localhost'
    subject: '[CONTAINER] Alert: {{ .GroupLabels.alertname }}'
    body: |
      Container Alert Detected
      
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      Container: {{ .Labels.name }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      {{ end }}

- name: 'monitoring-alerts'
  email_configs:
  - to: 'monitoring@localhost'
    subject: '[MONITORING] Alert: {{ .GroupLabels.alertname }}'
    body: |
      Monitoring System Alert
      
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      Service: {{ .Labels.job }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      {{ end }}
      
  webhook_configs:
  - url: 'http://localhost:5001/monitoring'
    send_resolved: true

- name: 'security-alerts'
  email_configs:
  - to: 'security@localhost'
    subject: '[SECURITY] URGENT Alert: {{ .GroupLabels.alertname }}'
    body: |
      SECURITY ALERT - IMMEDIATE ATTENTION REQUIRED
      
      {{ range .Alerts }}
      Alert: {{ .Annotations.summary }}
      Description: {{ .Annotations.description }}
      
      Labels:
      {{ range .Labels.SortedPairs }}
      - {{ .Name }}: {{ .Value }}
      {{ end }}
      
      Started: {{ .StartsAt }}
      {{ if .EndsAt }}Ended: {{ .EndsAt }}{{ end }}
      
      Please investigate immediately.
      
      {{ end }}
      
  webhook_configs:
  - url: 'http://localhost:5001/security'
    send_resolved: true