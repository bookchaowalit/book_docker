# Fluentd configuration for centralized logging
# Collects logs from Docker containers and forwards to Elasticsearch

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# Docker container logs
<source>
  @type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /fluentd/log/containers.log.pos
  tag docker.*
  format json
  time_key timestamp
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  refresh_interval 5
</source>

# System logs
<source>
  @type tail
  path /var/log/syslog
  pos_file /fluentd/log/syslog.log.pos
  tag system.syslog
  format syslog
  refresh_interval 5
</source>

# Docker daemon logs
<source>
  @type tail
  path /var/log/docker.log
  pos_file /fluentd/log/docker.log.pos
  tag system.docker
  format none
  refresh_interval 5
</source>

# Parse Docker container logs and extract metadata
<filter docker.**>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

# Add Docker container metadata
<filter docker.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    source docker
    container_id ${tag_parts[1]}
  </record>
</filter>

# Prometheus metrics logs
<filter docker.prometheus**>
  @type record_transformer
  <record>
    service prometheus
    log_type metrics
  </record>
</filter>

# Grafana logs
<filter docker.grafana**>
  @type record_transformer
  <record>
    service grafana
    log_type dashboard
  </record>
</filter>

# Application logs
<filter docker.app**>
  @type record_transformer
  <record>
    service application
    log_type application
  </record>
</filter>

# Database logs
<filter docker.db**>
  @type record_transformer
  <record>
    service database
    log_type data
  </record>
</filter>

# Infrastructure logs
<filter docker.infra**>
  @type record_transformer
  <record>
    service infrastructure
    log_type system
  </record>
</filter>

# Output to Elasticsearch
<match docker.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name docker-logs
  type_name _doc
  logstash_format true
  logstash_prefix docker
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 1s
  <buffer>
    @type file
    path /fluentd/buffer/docker
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 32MB
    queue_limit_length 128
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>

# System logs to Elasticsearch
<match system.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name system-logs
  type_name _doc
  logstash_format true
  logstash_prefix system
  logstash_dateformat %Y.%m.%d
  include_tag_key true
  tag_key @log_name
  flush_interval 1s
  <buffer>
    @type file
    path /fluentd/buffer/system
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 32MB
    queue_limit_length 128
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>

# Debug output for development
<match **>
  @type stdout
</match>